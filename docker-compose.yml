# =============================================================================
# Main Docker Compose Configuration - Updated for Unified MongoDB Container
# =============================================================================
# This compose file provides multiple deployment profiles:
# - dev: Development environment with hot-reload
# - prod: Production environment
# - prod-pm2: Production with PM2 process manager
# - nginx: Nginx reverse proxy only
# - prod-nginx: Production with nginx reverse proxy
# - test: Testing environment
# - unified: MongoDB Unified Container deployment
# =============================================================================

name: lynx-portfolio-back

# Include unified MongoDB configuration
include:
  - private-projects/mongo-backup-v2/docker/docker-compose.unified.yml

# Define reusable configuration
x-common-variables: &common-variables
  UID: ${UID:-1000}
  GID: ${GID:-1000}
  NODE_ENV: ${NODE_ENV:-development}

x-common-env: &common-env
  NODE_ENV: ${NODE_ENV:-development}
  CORS_ORIGIN: ${CORS_ORIGIN:-*}
  JWT_SECRET: ${JWT_SECRET:-your-jwt-secret}
  NGINX_HOST: ${NGINX_HOST:-localhost}
  NGINX_PORT: ${NGINX_PORT:-80}
  REDIS_URL: ${REDIS_URL:-}
  MONGO_APP_DB: ${MONGO_APP_DB:-lynx_portfolio}
  MONGO_APP_TEST_DB: ${MONGO_APP_TEST_DB:-lynx_portfolio_test}
  MONGO_APP_USER: ${MONGO_APP_USER:-database_user}
  MONGO_APP_PASSWORD: ${MONGO_APP_PASSWORD:-portfolio_pass}
  MONGO_AUTH_SOURCE: ${MONGO_AUTH_SOURCE:-admin}
  # S3 Storage Configuration
  S3_BUCKET_NAME: ${S3_BUCKET_NAME:-}
  S3_REGION: ${S3_REGION:-us-east-1}
  S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-}
  S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-}
  S3_ENDPOINT: ${S3_ENDPOINT:-https://s3.amazonaws.com}
  S3_UPLOAD_PREFIX: ${S3_UPLOAD_PREFIX:-uploads/}
  S3_KMS_KEY_ARN: ${S3_KMS_KEY_ARN:-}
  # CloudFront CDN Configuration
  CLOUDFRONT_DOMAIN: ${CLOUDFRONT_DOMAIN:-}
  CLOUDFRONT_DISTRIBUTION_ID: ${CLOUDFRONT_DISTRIBUTION_ID:-}
  # AWS IAM Configuration
  AWS_ROLE_TO_ASSUME: ${AWS_ROLE_TO_ASSUME:-}

services:
  # =============================================================================
  # Application Services
  # =============================================================================
  
  dev:
    build:
      context: .
      target: development
      args:
        <<: *common-variables
        NODE_ENV: development
    container_name: lynx-portfolio-back-dev
    depends_on:
      mongo-unified:
        condition: service_healthy
    ports:
      - "${DEV_PORT}:${DEV_PORT}"
    environment:
      <<: *common-env
      # Unified container connection (preferred)
      MONGO_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_DB:-lynx_portfolio}
      MONGO_TEST_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_TEST_DB:-lynx_portfolio_test}
      # Legacy fallback
      MONGO_URI_LEGACY: ${MONGO_URI}
      CHOKIDAR_USEPOLLING: ${CHOKIDAR_USEPOLLING:-false}
    volumes:
      # Mount source code for hot-reload (excludes node_modules for performance)
      - .:/app:cached
      - /app/node_modules
      - node_logs:/app/logs
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${DEV_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    profiles: ["dev", "unified"]
  prod:
    build:
      context: .
      target: production
      args:
        <<: *common-variables
        NODE_ENV: production
      cache_from:
        - node:22-alpine
    container_name: lynx-portfolio-back-prod
    depends_on:
      mongo-unified:
        condition: service_healthy
    ports:
      - "${PROD_PORT}:${PROD_PORT}"
    environment:
      <<: *common-env
      NODE_ENV: production
      # Unified container connection (preferred)
      MONGO_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_DB:-lynx_portfolio}
      MONGO_TEST_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_TEST_DB:-lynx_portfolio_test}
      # Legacy fallback
      MONGO_URI_LEGACY: ${MONGO_URI}
    volumes:
      - node_logs:/app/logs
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PROD_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    profiles: ["prod", "unified"]
  # Production service with PM2
  prod-pm2:
    build:
      context: .
      target: production-pm2
      args:
        <<: *common-variables
        NODE_ENV: production
    container_name: lynx-portfolio-back-prod-pm2
    depends_on:
      mongo-unified:
        condition: service_healthy
    ports:
      - "${PROD_PORT}:${PROD_PORT}"
    environment:
      <<: *common-env
      NODE_ENV: production
      # Unified container connection (preferred)
      MONGO_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_DB:-lynx_portfolio}
      MONGO_TEST_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_TEST_DB:-lynx_portfolio_test}
      # Legacy fallback
      MONGO_URI_LEGACY: ${MONGO_URI}
    volumes:
      - node_logs:/app/logs
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PROD_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    profiles: ["prod-pm2", "unified"]
  # Testing service
  test:
    build:
      context: .
      target: testing
      args:
        <<: *common-variables
        NODE_ENV: test
    container_name: lynx-portfolio-back-test
    depends_on:
      mongo-unified:
        condition: service_healthy
    environment:
      <<: *common-env
      NODE_ENV: test
      CI: "true"
      # Unified container connection (preferred)
      MONGO_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_TEST_DB:-lynx_portfolio_test}
      MONGO_TEST_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_TEST_DB:-lynx_portfolio_test}
      # Legacy fallback
      MONGO_URI_LEGACY: ${MONGO_URI}
      # Test-specific environment variables
      S3_BUCKET_NAME: "test-bucket"
      CLOUDFRONT_DOMAIN: "test.cloudfront.net"
      CLOUDFRONT_DISTRIBUTION_ID: "TEST123"
      S3_ACCESS_KEY_ID: "test-access-key"
      S3_SECRET_ACCESS_KEY: "test-secret-key"
      # Feature flags for testing
      USE_S3_CDN_STORAGE: "true"
      ENABLE_LEGACY_FILESYSTEM: "false"
      LOG_UPLOAD_PATHS: "false"
      FEATURE_FLAG_LOGGING: "false"
    volumes:
      - .:/app:cached
      - /app/node_modules
      - ./tests:/app/tests
      - ./coverage:/app/coverage
    networks:
      - app-network
    command: ["npm", "run", "test:ci"]
    profiles: ["test", "unified"]
  # Backend app service for nginx proxy
  app:
    build:
      context: .
      target: production
      args:
        <<: *common-variables
        NODE_ENV: production
    container_name: lynx-portfolio-back-app
    depends_on:
      mongo-unified:
        condition: service_healthy
    expose:
      - "6165"
    environment:
      <<: *common-env
      NODE_ENV: production
      # Unified container connection (preferred)
      MONGO_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_DB:-lynx_portfolio}
      MONGO_TEST_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_TEST_DB:-lynx_portfolio_test}
      # Legacy fallback
      MONGO_URI_LEGACY: ${MONGO_URI}
    volumes:
      - node_logs:/app/logs
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${DEV_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    profiles: ["nginx", "unified"]
  # Nginx reverse proxy service (standalone)
  nginx:
    build:
      context: .
      target: nginx
    container_name: lynx-portfolio-back-nginx
    depends_on:
      - app
      - mongo-unified
    ports:
      - "${NGINX_PORT}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx_logs:/var/log/nginx
    environment:
      NGINX_HOST: ${NGINX_HOST}
      NGINX_PORT: ${NGINX_PORT}
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/nginx-status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    profiles: ["nginx", "unified"]
  # Production service with integrated nginx
  prod-nginx:
    build:
      context: .
      target: production-nginx
      args:
        <<: *common-variables
        NODE_ENV: production
    container_name: lynx-portfolio-back-prod-nginx
    depends_on:
      mongo-unified:
        condition: service_healthy
    ports:
      - "${NGINX_PORT}:80"
    environment:
      <<: *common-env
      NODE_ENV: production
      # Unified container connection (preferred)
      MONGO_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_DB:-lynx_portfolio}
      MONGO_TEST_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_TEST_DB:-lynx_portfolio_test}
      # Legacy fallback
      MONGO_URI_LEGACY: ${MONGO_URI}
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - node_logs:/app/logs
      - nginx_logs:/var/log/nginx
      - supervisor_logs:/var/log/supervisor
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    profiles: ["prod-nginx", "unified"]

# =============================================================================
# Global Volume Definitions
# =============================================================================
volumes:
  # Application logs volume
  node_logs:
    driver: local
  
  # Nginx logs volume
  nginx_logs:
    driver: local
  
  # Supervisor logs volume (for prod-nginx)
  supervisor_logs:
    driver: local


# =============================================================================
# Global Network Definitions
# =============================================================================
networks:
  # Unified container network (preferred)
  app-network:
    name: ${COMPOSE_PROJECT_NAME:-portfolio}-network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${NETWORK_SUBNET:-172.20.0.0/16}
