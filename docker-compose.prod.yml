# =============================================================================
# Docker Compose - Production Environment Enhanced for Unified MongoDB
# =============================================================================
# This configuration provides production-ready optimizations for the unified
# MongoDB container and application services with security and performance tuning.
# =============================================================================

name: lynx-portfolio-back-prod

services:
  # =============================================================================
  # Application Service - Production Configuration  
  # =============================================================================
  lynx-portfolio-back-prod:
    build:
      context: .
      target: production
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
        NODE_ENV: production
    image: lynx-portfolio-back-app:latest
    container_name: lynx-portfolio-back-prod-app
    hostname: lynx-portfolio-back-app
    ports:
      - "${PROD_PORT:-6165}:6165"
    environment:
      API_BASE_URL: ${API_BASE_URL:-http://localhost:${PROD_PORT:-6165}}
      NODE_ENV: production
      # Keep internal app port at 6165 for consistency with Dockerfile healthcheck
      PORT: 6165
      CORS_ORIGIN: ${CORS_ORIGIN:-*}
      JWT_SECRET: ${JWT_SECRET:-your-jwt-secret}
      NGINX_HOST: ${NGINX_HOST:-localhost}
      NGINX_PORT: ${NGINX_PORT:-80}
      REDIS_URL: ${REDIS_URL:-}
      
      # Unified MongoDB connection (preferred)
      MONGO_APP_DB: ${MONGO_APP_DB:-lynx_portfolio}
      MONGO_APP_TEST_DB: ${MONGO_APP_TEST_DB:-lynx_portfolio_test}
      MONGO_APP_USER: ${MONGO_APP_USER:-portfolio}
      MONGO_APP_PASSWORD: ${MONGO_APP_PASSWORD:-portfolio_pass}
      MONGO_AUTH_SOURCE: ${MONGO_AUTH_SOURCE:-admin}
      MONGO_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_DB:-lynx_portfolio}
      MONGO_TEST_URI: mongodb://${MONGO_APP_USER:-portfolio}:${MONGO_APP_PASSWORD:-portfolio_pass}@mongo-unified:${MONGO_PORT:-27017}/${MONGO_APP_TEST_DB:-lynx_portfolio_test}
      
      # S3 Storage Configuration (production)
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-}
      S3_ENDPOINT: ${S3_ENDPOINT:-https://s3.amazonaws.com}
      S3_UPLOAD_PREFIX: ${S3_UPLOAD_PREFIX:-uploads/}
      S3_KMS_KEY_ARN: ${S3_KMS_KEY_ARN:-}
      
      # CloudFront CDN Configuration (production)
      CLOUDFRONT_DOMAIN: ${CLOUDFRONT_DOMAIN:-}
      CLOUDFRONT_DISTRIBUTION_ID: ${CLOUDFRONT_DISTRIBUTION_ID:-}
      
      # AWS IAM Configuration
      AWS_ROLE_TO_ASSUME: ${AWS_ROLE_TO_ASSUME:-}
      
      # Production feature flags
      USE_S3_CDN_STORAGE: "true"
      ENABLE_LEGACY_FILESYSTEM: "false"
      LOG_UPLOAD_PATHS: "false"
      FEATURE_FLAG_LOGGING: "false"
    volumes:
      - node_logs:/app/logs
    # Production resource limits
    deploy:
      resources:
        limits:
          memory: ${APP_MEMORY_LIMIT:-1G}
          cpus: '${APP_CPU_LIMIT:-1.0}'
        reservations:
          memory: 512M
          cpus: '0.5'
    # Production security
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp:noexec,nosuid,size=32m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6165/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

# =============================================================================
# Production Networks
# =============================================================================
networks:
  # Shared external network for separated app/database stacks
  default:
    external: true
    name: lynx-portfolio-back-network

# =============================================================================
# Production Volumes
# =============================================================================
volumes:
  # Application logs
  node_logs:
    name: lynx-portfolio-back-prod-logs
    driver: local
