# =============================================================================
# Docker Compose - Development (Standalone for Dokploy or local overrides)
# =============================================================================
# Run this stack when you want only the Node.js dev container. Make sure the
# MongoDB stack is already up so the MONGO_URI host is reachable.
# =============================================================================

name: lynx-portfolio-back-dev

services:
  dev:
    build:
      context: .
      target: development
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
        NODE_ENV: development
    image: lynx-portfolio-back-dev:latest
    container_name: lynx-portfolio-back-dev
    ports:
      - "${DEV_PORT:-6164}:${DEV_PORT:-6164}"
    environment:
      NODE_ENV: development
      CORS_ORIGIN: ${CORS_ORIGIN:-*}
      JWT_SECRET: ${JWT_SECRET:-your-jwt-secret}
      NGINX_HOST: ${NGINX_HOST:-localhost}
      NGINX_PORT: ${NGINX_PORT:-80}
      REDIS_URL: ${REDIS_URL:-}
      MONGO_APP_DB: ${MONGO_APP_DB:-lynx_portfolio}
      MONGO_APP_TEST_DB: ${MONGO_APP_TEST_DB:-lynx_portfolio_test}
      MONGO_APP_USER: ${MONGO_APP_USER:-database_user}
      MONGO_APP_PASSWORD: ${MONGO_APP_PASSWORD:-portfolio_pass}
      MONGO_AUTH_SOURCE: ${MONGO_AUTH_SOURCE:-admin}
      MONGO_URI: ${MONGO_URI}
      CHOKIDAR_USEPOLLING: ${CHOKIDAR_USEPOLLING:-false}
      # S3 Storage Configuration
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-}
      S3_ENDPOINT: ${S3_ENDPOINT:-https://s3.amazonaws.com}
      S3_UPLOAD_PREFIX: ${S3_UPLOAD_PREFIX:-uploads/}
      S3_KMS_KEY_ARN: ${S3_KMS_KEY_ARN:-}
      # CloudFront CDN Configuration
      CLOUDFRONT_DOMAIN: ${CLOUDFRONT_DOMAIN:-}
      CLOUDFRONT_DISTRIBUTION_ID: ${CLOUDFRONT_DISTRIBUTION_ID:-}
      # AWS IAM Configuration
      AWS_ROLE_TO_ASSUME: ${AWS_ROLE_TO_ASSUME:-}
    volumes:
      - .:/app:cached
      - /app/node_modules
      - node_logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${DEV_PORT:-6164}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

networks:
  default:
    external: true
    name: lynx-portfolio-back-network

volumes:
  node_logs:
    name: lynx-portfolio-back-logs
    driver: local
